#
# PRE: update
#

update request {
	&Tunnel-Server-Endpoint   := '192.0.1.1'	# Should not be tagged
	&Tunnel-Server-Endpoint:0 += '192.0.1.2'	# Should not be tagged
	&Tunnel-Server-Endpoint:1 := '192.0.2.1'
	&Tunnel-Server-Endpoint:1 += '192.0.2.2'
	&Tunnel-Server-Endpoint:2 := '192.0.3.1'
	&Tunnel-Server-Endpoint:2 += '192.0.3.2'
}

update request {
	&Tmp-Integer-0 := 0
}

# Check the tag printing xlat works correctly
if ("%{tag:Tunnel-Server-Endpoint[0]}" != '') {
	test_fail
}

if ("%{tag:Tunnel-Server-Endpoint[1]}" != '') {
	test_fail
}


if ("%{tag:Tunnel-Server-Endpoint[2]}" != '1') {
	test_fail
}

if ("%{tag:Tunnel-Server-Endpoint[5]}" != '2') {
	test_fail
}

if ("%{tag:Tunnel-Server-Endpoint[6]}" != '') {
	test_fail
}

if ("%{tag:control:Cleartext-Password[0]}" != '') {
	test_fail
}

# There should be no failures so far
if (&Module-Failure-Message) {
	test_fail
}

# Test invalid attributes
if ("%{tag:foo}" != "") {
	test_fail
}

if (&Module-Failure-Message != "Unknown attribute 'foo'") {
	test_fail
}

update request {
	&Module-Failure-Message !* ANY
}

if ("%{tag:%{control:Cleartext-Password}}" != "") {
	test_fail
}

if (&Module-Failure-Message != "Unknown attribute 'hello'") {
	test_fail
}

update request {
	&Module-Failure-Message !* ANY
}

# Check that access attributes by tag works first
if ("%{Tunnel-Server-Endpoint:2}" != '192.0.3.1') {
	test_fail
}

# Get the first instance of Tunnel-Server-Endpoint:2
if ("%{Tunnel-Server-Endpoint:2[0]}" != '192.0.3.1') {
	test_fail
}

# Get the first instance of Tunnel-Server-Endpoint:2
if ("%{Tunnel-Server-Endpoint:2[1]}" != '192.0.3.2') {
	test_fail
}

if ("%{Tunnel-Server-Endpoint:0[2]}" != '') {
	test_fail
}

if ("%{Tunnel-Server-Endpoint:0[0]}" != '192.0.1.1') {
	test_fail
}

if ("%{Tunnel-Server-Endpoint:0[1]}" != '192.0.1.2') {
	test_fail
}

if ("%{Tunnel-Server-Endpoint:0[2]}" != '') {
	test_fail
}

#
# Selecting on attributes with no tag specified (should match all of that type)
#
if ("%{Tunnel-Server-Endpoint[0]}" != '192.0.1.1') {
	test_fail
}

if ("%{Tunnel-Server-Endpoint[1]}" != '192.0.1.2') {
	test_fail
}

if ("%{Tunnel-Server-Endpoint[2]}" != '192.0.2.1') {
	test_fail
}

#
# Assignment (xlat)
#
update request {
	&Tmp-String-0 += "%{Tunnel-Server-Endpoint:2[0]}"	#0
	&Tmp-String-0 += "%{Tunnel-Server-Endpoint:2[0]}"	#1
	&Tmp-String-0 += "%{Tunnel-Server-Endpoint:1[0]}"	#2
	&Tmp-String-0 += "%{Tunnel-Server-Endpoint:2[0]}"	#3
	&Tmp-String-0 += "%{Tunnel-Server-Endpoint:2[1]}"	#4
	&Tmp-String-0 += "%{Tunnel-Server-Endpoint:0[0]}"	#5
	&Tmp-String-0 += "%{Tunnel-Server-Endpoint:0[1]}"	#6
	&Tmp-String-0 += "%{Tunnel-Server-Endpoint:0[2]}"	#7 - Empty
	&Tmp-String-0 += "%{Tunnel-Server-Endpoint[0]}"		#8
	&Tmp-String-0 += "%{Tunnel-Server-Endpoint[1]}"		#9
	&Tmp-String-0 += "%{Tunnel-Server-Endpoint[2]}"		#10
}

# Check that access attributes by tag works first
if (&Tmp-String-0[0] != '192.0.3.1') {
	test_fail
}

if (&Tmp-String-0[1] == '192.0.3.2') {
	test_fail
}

if (&Tmp-String-0[2] != '192.0.2.1') {
	test_fail
}

# Get the first instance of Tunnel-Server-Endpoint:2
if (&Tmp-String-0[3] != '192.0.3.1') {
	test_fail
}

# Get the first instance of Tunnel-Server-Endpoint:2
if (&Tmp-String-0[4] != '192.0.3.2') {
	test_fail
}

# Now check the assignment
if (&Tmp-String-0[5] != '192.0.1.1') {
	test_fail
}

if (&Tmp-String-0[6] != '192.0.1.2') {
	test_fail
}

if (&Tmp-String-0[7] != '') {
	test_fail
}

if (&Tmp-String-0[8] != '192.0.1.1') {
	test_fail
}

if (&Tmp-String-0[9] != '192.0.1.2') {
	test_fail
}

if (&Tmp-String-0[10] != '192.0.2.1') {
	test_fail
}

success
