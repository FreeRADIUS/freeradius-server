#
#  Test thread-scoped interval limiting
#
#  Each xlat call site has its own interval limit counter, so keyless calls
#  at different locations are independent. Use keyed interval limiting to
#  test blocking behavior.
#

#
#  First keyless call should be allowed (new call site)
#
if (%interval_thread(1s)) {
	reply += {
		Reply-Message = "first allowed"
	}
} else {
	reply += {
		Reply-Message = "first blocked - FAIL"
	}
}

#
#  Second keyless call also allowed (different call site)
#
if (%interval_thread(1s)) {
	reply += {
		Reply-Message = "second allowed"
	}
} else {
	reply += {
		Reply-Message = "second blocked - FAIL"
	}
}

#
#  Keyed interval limit - first call with key should be allowed
#
if (%interval_thread(1s, 'testkey')) {
	reply += {
		Reply-Message = "keyed first allowed"
	}
} else {
	reply += {
		Reply-Message = "keyed first blocked - FAIL"
	}
}

#
#  Keyed interval limit - second call with same key should be blocked
#
if (%interval_thread(1s, 'testkey')) {
	reply += {
		Reply-Message = "keyed second allowed - FAIL"
	}
} else {
	reply += {
		Reply-Message = "keyed second blocked"
	}
}

#
#  Advance time past the 1s interval
#
%time.advance(1100ms)

#
#  After the interval, the keyed interval limit should allow again
#
if (%interval_thread(1s, 'testkey')) {
	reply += {
		Reply-Message = "keyed after interval allowed"
	}
} else {
	reply += {
		Reply-Message = "keyed after interval blocked - FAIL"
	}
}

control.Password.Cleartext := "hello"
