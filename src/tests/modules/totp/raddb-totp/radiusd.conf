#
#  Minimal radiusd.conf for TOTP testing.  NOTE: This configuraiton
#  is suitable for TESTING ONLY.
#
#  It only runs TOTP. It does not authenticate a user in any other way,
#  and it uses the same TOTP secret for all users.  It is NOT suitable
#  for use in a production environment.
#
raddb        = $ENV{RADDB}
modconfdir   = ${raddb}/mods-config
testdir      = $ENV{TEST_PATH}
pidfile      = ${testdir}/radiusd.pid
panic_action = "gdb -batch -x ${raddb}/panic.gdb %e %p > ${testdir}/gdb-radiusd.log 2>&1; cat ${testdir}/gdb-radiusd.log"
certdir      = ${raddb}/certs
cadir        = ${raddb}/certs
libdir       = $ENV{LIB_PATH}

max_requests = 1048576

thread pool {
	start_servers = 5
	max_servers = 32
	min_spare_servers = 3
	max_spare_servers = 10
	max_requests_per_server = 0
	cleanup_delay = 5
	max_queue_size = 65536
	auto_limit_acct = no
}

#
#  Referenced by some modules for default thread pool configuration
#
modules {
	
$INCLUDE ${raddb}/mods-available/always

totp {
	 time_step = 30
	 otp_length = 6
	 lookback_steps = 1
	 lookback_interval = 30
	 }
}

clients mine {
	client me {
		ipaddr = 127.0.0.1
		secret = testing123
	}
}

listen {
	type = auth

	ipaddr = 127.0.0.1
	port = $ENV{FR_LOCAL_PREFIX}1812
	proto = udp

	clients = mine

	virtual_server = default

}

listen {
	type = acct

	ipaddr = 127.0.0.1
	port = $ENV{FR_LOCAL_PREFIX}1813
	proto = udp

	clients = mine

	virtual_server = default

}

server default {

	authorize {
	          if (!User-Password) {
		         reject
		  }
		  
		  update request {
		  	 &TOTP-Password := &User-Password
		  }
		  update control {
			 &Auth-Type := totp
			 &TOTP-Secret := JBSWY3DPEHPK3PXP
		  }
	}
	
        authenticate {
		  totp
	}

	preacct {
		update control {
			&Response-Packet-Type := Accounting-Response
		}
	}

	acct {
		        ok
	}
}
