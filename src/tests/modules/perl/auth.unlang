#  Initial user will be rejected by the perl script.
perl.authenticate

#  fail has been used as the return code so the test doesn't exit.
if (!notfound) {
    test_fail
}

if !(&reply.Reply-Message == "Denied access by rlm_perl function") {
    test_fail
}

&reply -= &Reply-Message[*]

#  User will not be rejected - an xlat will be called setting a reply attribute
&User-Name := 'bob'

perl.authenticate

if (!ok) {
    test_fail
}

# TODO: Re-enable when nested attributes are handled
#if !(&reply.Vendor-Specific.Cisco.h323-credit-amount == 100) {
#    test_fail
#}
if !(&reply.Filter-Id == 'Hello') {
	test_fail
}
# Verify that the change to the request and control lists are
# not copied back.
if (&User-Name != 'bob') {
	test_fail
}
if (&control.NAS-Identifier) {
	test_fail
}

&reply -= &Vendor-Specific.Cisco.h323-credit-amount[*]
&reply -= &Filter-Id[*]

test_pass
