# ---------------------------------------------------------------
# Docker Compose Test Environment:
#
#                  --> HS1 (auto-accept)
#
#                  --> HS2 (auto-accept)
#
#   load-generator --> HS3 (auto-accept)
#
#                  --> HS4 (auto-accept)
#
#                  --> HS5 (auto-accept)
#
# ---------------------------------------------------------------
x-common-config: &id001
  cap_add:
  - NET_ADMIN
  - SYS_PTRACE
services:
{% for i in range(1, (compose_num_of_home_servers + 1)) %}
  homeserver{{ i }}:
    image: freeradius-build:latest
    volumes:
    - ${DATA_PATH}/freeradius/homeserver/radiusd.conf:/etc/raddb/radiusd.conf
    - ${DATA_PATH}/freeradius/env-setup.sh:/tmp/env-setup.sh
    - ${LISTENER_DIR}/:/var/run/multi-server/
    command: radiusd -X
    restart: unless-stopped
    entrypoint:
    - bash
    - -lc
    - |
      set -euo pipefail

      # Next three lines based on test-framework test config example
      source /tmp/env-setup.sh
      export TEST_PROJECT_NAME=${COMPOSE_PROJECT_NAME}

      exec /docker-entrypoint.sh "$@"
      sleep infinity
    <<: *id001
{% endfor %}
  load-generator:
    image: freeradius-build:latest
    ports:
      # Expose RADIUS ports for load generator to allow us to access the server from outside docker
      - "1812:1812/udp"
      - "1813:1813/udp"
      - "1820:1820/udp"
    depends_on:
{% for i in range(1, (compose_num_of_home_servers + 1)) %}
      - homeserver{{ i }}
{% endfor %}
    volumes:
    # load-generator templates
    - ${DATA_PATH}/freeradius/load-generator/template.d/load-generator-templates:/etc/raddb/template.d/load-generator-templates

    # Setup a testuser/testpass user for authentication testing with load-generator
    # This is only really needed when testing the load-generator with radclient during development.
    - ${DATA_PATH}/freeradius/load-generator/mods-config/files/authorize:/etc/raddb/mods-config/files/authorize

    # load-generator server config
    - ${DATA_PATH}/freeradius/load-generator/radiusd.conf:/etc/raddb/radiusd.conf

    - ${DATA_PATH}/freeradius/env-setup.sh:/tmp/env-setup.sh
    - ${DATA_PATH}/freeradius/load-generator/load-generator-packets/:/etc/raddb/load-generator-packets/
    - ${LISTENER_DIR}/:/var/run/multi-server/
    environment:
      TEST_PROJECT_NAME: ${COMPOSE_PROJECT_NAME}
      TEST_CONF_START_PPS: 5
      TEST_CONF_MAX_PPS: 10
      TEST_CONF_DURATION: 5
      TEST_CONF_STEP: 5
      TEST_CONF_PARALLEL: 1
      TEST_CONF_MAX_BACKLOG: 1000
      TEST_CONF_REPEAT: "no"
    entrypoint:
    - bash
    - -lc
    - |
      set -euo pipefail

      source /tmp/env-setup.sh
      export TEST_PROJECT_NAME=${COMPOSE_PROJECT_NAME}

      sleep infinity
    <<: *id001
