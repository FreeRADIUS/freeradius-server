name       = load-generator

raddbdir   = /etc/freeradius
confdir    = ${raddbdir}
modconfdir = ${confdir}/mods-config
logdir     = /var/log/freeradius
radacctdir = ${logdir}/radacct

templates {
	$INCLUDE template.d/
}

security {
	allow_core_dumps = yes
}

# logging configuration required for linelog module
log {
	destination = files
	file = ${logdir}/radius.log
	syslog_facility = daemon
	stripped_names = no
	auth = yes
	auth_badpass = yes
	auth_goodpass = yes
}

modules {
	# TODO: Replace linelog {...} with Jinja template
	#{% include "../../../../../raddb/mods-available/linelog" %}
	linelog {
		format = "This is a log message for %{User-Name}"
		destination = file

		file {
			filename = ${logdir}/linelog
			permissions = 0600
			escape_filenames = no
		}
	}

	linelog log_stdout {
		destination = stdout
	}

	linelog log_unix_sock {
		destination = file

		file {
			filename = /var/run/multi-server/$ENV{TEST_PROJECT_NAME}.txt
			permissions = 0644
			escape_filenames = no
		}
	}

	# TODO: Replace linelog_test_framework config instance with Jinja template
	#{% if filesystem_type == "file" %}
	#	{% include "linelog_file" %}
	#{% elif filesystem_type == "socket" %}
	#	{% include "linelog_socket" %}
	#{% else %}
	#	# div by 0 to cause error
	#	{% set _ = 1 / 0 %}
	#{% endif %}
	linelog linelog_test_framework {
		destination = file

		file {
			filename = /var/run/multi-server/$ENV{TEST_PROJECT_NAME}.txt
			permissions = 0644
			escape_filenames = no
		}
	}


	# TODO: Replace with Jinja template
	#{% include "../../../../../raddb/mods-available/stats" %}
	stats {

	}

	radius radius-module-homeserver1 {
		$template radius-module-homeserver-tmpl
		udp {
			ipaddr = homeserver1
		}
	}

	radius radius-module-homeserver2 {
		$template radius-module-homeserver-tmpl
		udp {
			ipaddr = homeserver2
		}
	}

	radius radius-module-homeserver3 {
		$template radius-module-homeserver-tmpl
		udp {
			ipaddr = homeserver3
		}
	}

	radius radius-module-homeserver4 {
		$template radius-module-homeserver-tmpl
		udp {
			ipaddr = homeserver4
		}
	}

	radius radius-module-homeserver5 {
		$template radius-module-homeserver-tmpl
		udp {
			ipaddr = homeserver5
		}
	}

}

server load-generator {

	namespace = radius

	listen load {
		handler = load
		type = Access-Request
		transport = step

		step {

			# Default packet config to use by the load-generator
			filename = ${confdir}/load-generator-packets/packet.conf

			csv = ${confdir}/stats/load-generator-client-stats.csv

			max_attributes = 64

			#
			# The load profile is configured via environment variables set
			# in the testcase configuration files.
			#
			start_pps = $ENV{TEST_CONF_START_PPS}
			max_pps   = $ENV{TEST_CONF_MAX_PPS}
			duration  = $ENV{TEST_CONF_DURATION}
			step = $ENV{TEST_CONF_STEP}
			max_backlog = $ENV{TEST_CONF_MAX_BACKLOG}
			parallel = $ENV{TEST_CONF_PARALLEL}
			num_messages = $ENV{TEST_CONF_NUM_MESSAGES}
			repeat = no
		}
	}

	listen authentication {
		type = Access-Request
		type = Status-Server
		transport = udp
		require_message_authenticator = auto
		limit_proxy_state = auto

		limit {
			max_clients = 256
			max_connections = 256
			idle_timeout = 60.0
			dynamic_timeout = 600.0
			nak_lifetime = 30.0
			cleanup_delay = 5.0
		}

		udp {
			ipaddr = *
			port = 1812
			networks {
				allow = 127/8
				allow = 192.0.2/24
			}
		}

		tcp {
			ipaddr = *
			port = 1812
			networks {
				allow = 127/8
				allow = 192.0.2/24
			}
		}
	}

	listen authentication {
		type = Access-Request
		type = Status-Server
		transport = tcp

		tcp {
			ipaddr = *
			port = 1812
			networks {
				allow = 127/8
				allow = 192.0.2/24
			}
		}
	}

	client localhost {
		shortname = client-localhost
		ipaddr = *
		secret = testing123
	}

	listen statusserver {
		transport = udp
		udp {
			ipaddr = *
			port = 1820
		}

		type = Status-Server
	}

	#
	#  Receive a Status-Server packet
	#
	recv Status-Server {
		# stats module required to have access to the Status-Server's global statistics
		stats

		%linelog_test_framework("loadgen-recv-status-server - INFO - reply.FreeRADIUS.Stats4.Packet-Counters.Status-Server: %{reply.FreeRADIUS.Stats4.Packet-Counters.Status-Server || 0}")
		%linelog_test_framework("loadgen-recv-status-server - INFO - reply.FreeRADIUS.Stats4.Packet-Counters.Access-Request: %{reply.FreeRADIUS.Stats4.Packet-Counters.Access-Request || 0}")
		%linelog_test_framework("loadgen-recv-status-server - INFO - reply.FreeRADIUS.Stats4.Packet-Counters.Access-Accept: %{reply.FreeRADIUS.Stats4.Packet-Counters.Access-Accept || 0}")
		%linelog_test_framework("loadgen-recv-status-server - INFO - reply.FreeRADIUS.Stats4.Packet-Counters.Access-Reject: %{reply.FreeRADIUS.Stats4.Packet-Counters.Access-Reject || 0}")

		# The Stats Module documentation explicitly states: "When listed in a recv Status-Server section, it will add global server statistics to the packet,
		# hence the reason "reply.FreeRADIUS.Stats4" is used below.
		if ((reply.FreeRADIUS.Stats4.Packet-Counters.Access-Accept - reply.FreeRADIUS.Stats4.Packet-Counters.Status-Server) != reply.FreeRADIUS.Stats4.Packet-Counters.Access-Request) {
			%linelog_test_framework("loadgen-recv-status-server - ERROR - expected vs actual stat missmatch, reply.FreeRADIUS.Stats4.Packet-Counters.Access-Request = %{reply.FreeRADIUS.Stats4.Packet-Counters.Access-Request}, reply.FreeRADIUS.Stats4.Packet-Counters.Access-Accept = %{reply.FreeRADIUS.Stats4.Packet-Counters.Access-Accept}, reply.FreeRADIUS.Stats4.Packet-Counters.Status-Server: %{reply.FreeRADIUS.Stats4.Packet-Counters.Status-Server}")
		}

		if (reply.FreeRADIUS.Stats4.Packet-Counters.Access-Request == (reply.FreeRADIUS.Stats4.Packet-Counters.Access-Accept - reply.FreeRADIUS.Stats4.Packet-Counters.Status-Server)) {
			%linelog_test_framework("loadgen-recv-status-server - INFO - %{reply.FreeRADIUS.Stats4.Packet-Counters.Access-Request} requests processed successfully, reply.FreeRADIUS.Stats4.Packet-Counters.Access-Request = %{reply.FreeRADIUS.Stats4.Packet-Counters.Access-Request}, reply.FreeRADIUS.Stats4.Packet-Counters.Access-Accept = %{reply.FreeRADIUS.Stats4.Packet-Counters.Access-Accept}, reply.FreeRADIUS.Stats4.Packet-Counters.Status-Server = %{reply.FreeRADIUS.Stats4.Packet-Counters.Status-Server}")
		}
	}

	recv Access-Request {
		# Use the load-generator-proxy authenticate logic
		control.Auth-Type := "load-generator-proxy"
	}

	authenticate load-generator-proxy {
		# Use redundant-load-balance to distribute requests to multiple home servers
		redundant-load-balance {
			radius-module-homeserver1
			radius-module-homeserver2
			radius-module-homeserver3
			radius-module-homeserver4
			radius-module-homeserver5
		}
	}

	send Access-Accept {
		stats
	}

	send Access-Reject {
		stats
	}

}
