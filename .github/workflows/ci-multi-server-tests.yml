name: Multi-Server CI Tests

on:
  push:
    branches-ignore:
      - coverity_scan
      - run-fuzzer**
      - debug-fuzzer-**
  pull_request:
    paths:
      - '.github/workflows/ci-multi-server-tests.yml'
      - 'src/tests/multi-server/**'
  workflow_dispatch:

jobs:
  test-5hs-autoaccept-selfhosted:
    runs-on: self-hosted

    services:
      dind:
        image: docker:dind
        options: --privileged
        env:
          DOCKER_TLS_CERTDIR: ""
          #  Bypass the squid proxy for internal registry access.
          NO_PROXY: "*.networkradius.com,127.0.0.1"
        #  Mount the host's internal CA so dind trusts
        #  docker.internal.networkradius.com for image pulls.
        volumes:
          - /usr/local/share/ca-certificates/networkradius.com.crt:/etc/docker/certs.d/docker.internal.networkradius.com/ca.crt:ro

    env:
      MULTI_SERVER_TEST_LOG: build/tests/multi-server/freeradius-multi-server/multi_server_test.log
      MULTI_SERVER_TEST_LISTENER_LOG: build/tests/multi-server/freeradius-listener-logs/custom_test-env-5hs-autoaccept.txt.bak

    container:
      image: docker.internal.networkradius.com/self-hosted
      #  "privileged" is needed for Samba install
      #  "memory-swap -1" enables full use of host swap and may help
      #    with containers randomly quitting with "The operation was
      #    canceled"
      options: >-
        --privileged
        --memory-swap -1
      env:
        DOCKER_HOST: tcp://dind:2375
        NO_PROXY: dind

    steps:

      - name: Install extra packages
        run: |
          apt-get update && apt-get install -y --no-install-recommends docker.io docker-buildx docker-compose-v2 python3-venv

      # Checkout, but defer pulling LFS objects until we've restored the cache
      - uses: actions/checkout@v4
        with:
          lfs: false

      #  Authenticate to the internal registry via the dind daemon.
      #  The host Docker daemon is logged in via the runner's
      #  job-started hook, but dind is a separate daemon with no
      #  auth config.
      - name: Login to internal Docker registry
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_REPO_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_REPO_PASSWORD }}
        run: |
          echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin https://docker.internal.networkradius.com/

      - name: Build Docker image from source
        run: |
          make docker.ubuntu24.build
          docker tag freeradius4/ubuntu24:latest freeradius-build:latest
          docker images --all

      - name: Run test-5hs-autoaccept test
        run: |
          make -f src/tests/multi-server/all.mk test-5hs-autoaccept

      - name: Verify test results
        shell: bash
        run: |
          set -euo pipefail

          echo "============ ${MULTI_SERVER_TEST_LOG} ============"
          cat "${MULTI_SERVER_TEST_LOG}"

          if grep -q '\[Failed\]' "${MULTI_SERVER_TEST_LOG}"; then
            echo "TEST FAILED: Found [Failed] in log"
            grep '\[Failed\]' "${MULTI_SERVER_TEST_LOG}"

            # Display the framework's listener log for debugging purposes
            echo "============ ${MULTI_SERVER_TEST_LISTENER_LOG} ============"
            cat "${MULTI_SERVER_TEST_LISTENER_LOG}"
            exit 1
          fi

          if grep -Eq '\(Failures:[[:space:]]*[1-9][0-9]*[[:space:]]*\)' "${MULTI_SERVER_TEST_LOG}"; then
            echo "TEST FAILED: Found Failures > 0 in log"
            grep -E '\(Failures:[[:space:]]*[1-9][0-9]*[[:space:]]*\)' "${MULTI_SERVER_TEST_LOG}"

            # Display the framework's listener log for debugging purposes
            echo "============ ${MULTI_SERVER_TEST_LISTENER_LOG} ============"
            cat "${MULTI_SERVER_TEST_LISTENER_LOG}"
            exit 1
          fi

          log="${MULTI_SERVER_TEST_LOG}"
          if awk '
            BEGIN { found=0; n1=0; n2=0; line="" }
            index($0,"Matched:") {
              orig=$0
              s=$0
              gsub(/[[:space:]]/, "", s)
              sub(/^.*Matched:/, "", s)
              sub(/\(.*/, "", s)
              n = split(s, parts, "/")
              if (n == 2) {
                a = parts[1] + 0
                b = parts[2] + 0
                if (a > 0 && a == b) { found=1; n1=a; n2=b; line=orig }
              }
            }
            END {
              if (found) { printf "MATCH: %d / %d\nMatched line: %s\n", n1, n2, line; exit 0 }
              exit 1
            }
          ' "$log"
          then
            : # PASS
          else
            echo "TEST FAILED: No Matched line found with equal non-zero counts"

            # Display the framework's listener log for debugging purposes
            echo "============ ${MULTI_SERVER_TEST_LISTENER_LOG} ============"
            cat "${MULTI_SERVER_TEST_LISTENER_LOG}"
            exit 1
          fi

      #
      #  If the CI has failed and the branch is loadgen-5hs-tests then we start a tmate
      #  session to provide interactive shell access to the session.
      #
      #  The SSH rendezvous point will be emited continuously in the job output,
      #  which will look something like:
      #
      #      SSH: ssh VfuX8SrNuU5pGPMyZcz7TpJTa@sfo2.tmate.io
      #
      #  For example:
      #
      #      git push origin loadgen-5hs-tests --force
      #
      #  Look at the job output in: https://github.com/FreeRADIUS/freeradius-server/actions
      #
      #      ssh VfuX8SrNuU5pGPMyZcz7TpJTa@sfo2.tmate.io
      #
      #  Access requires that you have the private key corresponding to the
      #  public key of the GitHub user that initiated the job.
      #
      - name: "Debug: Start tmate"
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true
        if: ${{ github.ref == 'refs/heads/loadgen-5hs-tests' && failure() }}
