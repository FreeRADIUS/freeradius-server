= Policies

*Goal:* Create and use policies to abstract and reuse business logic in FreeRADIUS.

*Time:* 10-20 minutes

*Files / Directories:*

- `etc/raddb/policy.d/*`   (policy.d where we create and define policies)
- `etc/raddb/sites-available/default`  (virtual server where we call the policy)

*Related man page:* `man unlang`

== Preparation

Look through the existing files in `etc/raddb/policy.d/` and review other documentation sections (especially the unlang reference, conditions, and regular expressions) to become familiar with:

- Policy syntax
- Attribute references (`request.`, `control.`, `reply.`, etc.)
- Regular expression matching in `if` conditions
- Common update operators (`:=`, `+=`, etc.)

Policies are named blocks of unlang code that can be called almost anywhere a module can be called.

Basic structure of a policy:

[source,text]
----
policy_name {
    # unlang statements here
}
----
Example:

You have already created a policy named realm-split in the xref:unlang_splitting_strings.adoc[Splitting Strings] tutorial.

File: etc/raddb/policy.d/realm-split

[source,text]
----
realm-split {
    # Check if User-Name exists and contains an "@" symbol
    if (request.User-Name =~ /^([^@]+)@(.+)$/) {

        # First capture group - username part (before @)
        request.Stripped-User-Name := %regex.match(1)

        # Second capture group - domain/realm part (after @)
        control.Stripped-User-Domain := %regex.match(2)

        # IMPORTANT: Override User-Name with just the username part
        # This allows the users file to match on "bob" instead of "bob@realm1.com"
        request.User-Name := request.Stripped-User-Name

        # Add reply attributes to validate the split worked correctly
        # Using Reply-Message to show both values (visible in reply)
        reply += {
            Reply-Message = "User: %{request.Stripped-User-Name}"
            Reply-Message = "Domain: %{control.Stripped-User-Domain}"
        }
    }
}
----

Task: Call this policy at the very beginning of the authorize {} section in the default virtual server.

Open the file:

[source]
----
$ vi etc/raddb/sites-available/default
----

Add the policy call near the top of the authorize section:

[source,text]
----
authorize {
    realm-split
    # ... rest of your authorize section (chap, mschap, digest, files, etc.) ...
}
----

Placing it early ensures the username is stripped and cleaned before any local authorization modules (like files, sql, ldap, etc.) try to match it.

== Questions

1.  What are the advantages of using the policy language over interpreted
    language modules?
2.  What are the main differences between a policy and a function in other
    languages?

// Copyright (C) 2021 Network RADIUS SAS.  Licenced under CC-by-NC 4.0.
// This documentation was developed by Network RADIUS SAS.
