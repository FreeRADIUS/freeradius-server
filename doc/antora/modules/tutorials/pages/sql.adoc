= Communicating with an SQL database

*Goal:* Configure the server so that it can communicate with an SQL database and retrieve user authentication and authorisation information directly from that database instead of (or in addition to) the flat `authorize` file.

*Time:* 25–45 minutes

*Files you will need to look at or edit:*

- `mods-available/sql`
- `mods-config/sql/main/<dialect>/schema.sql`
- `mods-config/sql/main/<dialect>/queries.conf`
- `sites-enabled/default`

Many sites start with user information stored in the classic `authorize` file because it is simple and quick to edit. However, once the number of authorize grows into the thousands — or especially into the tens or hundreds of thousands — maintaining that file becomes impractical. Flat files do not offer fast indexed lookups, concurrent writes from multiple tools become dangerous, and most network management systems or billing platforms cannot easily update a text file safely.

This is where SQL databases become very attractive. Modern relational databases are designed to handle millions of records, provide extremely fast indexed searches, support transactions, allow many different applications to read and write data safely, and come with a huge ecosystem of management tools, backup solutions, replication options, and monitoring integrations.

The schema that freeRADIUS uses is deliberately designed to behave in a very similar way to the `files` module. The tables `radcheck` and `radreply` correspond almost directly to check items and reply items in the `authorize` file. The `radusergroup` table handles group membership, and `radgroupcheck` / `radgroupreply` provide the group-level equivalents. In most cases, if something works in the `authorize` file, the same logic can be made to work in SQL with very little change to your policies.

Each SQL dialect supported by freeRADIUS (sqlite, mysql, postgresql, mssql, oracle, etc.) has its own subdirectory under:

`mods-config/sql/main/<dialect>/`

Inside you will find:

- `schema.sql` — the schema that create the required tables and indexes
- `queries.conf` — the actual SQL queries that executes during authorisation, accounting, post-auth, etc.

The main configuration file for the module itself lives in `mods-available/sql`. This file contains the connection parameters, pool settings, dialect selection, and — most importantly — an `$INCLUDE` directive that pulls in the correct dialect-specific `queries.conf`.

The first step is to configure the server to use the SQL module, and to
communicate with the SQL database. Edit the `radiusd.conf` file, and
look for the `instantiate` section. Inside of that section, add one line
containing the word `sql`, as follows:

------------------------------------------
instantiate {
        sql     # start up the SQL module.
}
------------------------------------------

This tells the server to look for, and use, the `sql` module when the
server starts. Note that since the `sql` module is not listed in any of
the "authorize", "authenticate", etc. sections, it will not be used
in to process any authentication requests, or accounting requests. For
now, we are interested solely in making the FreeRADIUS server
communicate with the SQL server.

Open `mods-available/sql` verify that the first few configuration
entries are correct. That is, the "server", "login", and "password"
entries should be set up correctly for your local SQL database.

If using sqlite, these entries can be left commented out as they're not
required, but you should uncomment the `sqlite {}` section and the
configuration items within that section.

FreeRADIUS uses the `rlm_sql` module to interface with the SQL
databases. You should check that this module is installed by doing:

[source, bash]
--------------------------------------
$ ls -l usr/lib64/freeradius/rlm_sql*
--------------------------------------

(Or, the directory wherever the FreeRADIUS libraries were installed.)

You should see not only files like "rlm_sql.so", but also
"rlm_sql_mysql.so", or "rlm_sql_sqlite.so". If you do not see
"rlm_sql.so", or you do not see the sub-module which interfaces with
your SQL server, you will have to install it now. You may do this by
going to the rlm_sql subdirectory, and building the module:

[source, bash]
------------------------
$ cd freeradius-server/src/modules/rlm_sql
$ ./configure
$ make
$ make install
------------------------

This exercise has insufficient room to describe how to debug any
configuration, build, or installation problems with the SQL drivers. For
the remainder of this exercise, we will assume that the driver is
installed in the appropriate library directory.

Once you have verified that the SQL driver exists, have enabled the module
by creating a symlink from `mods-available/sql` to
`mods-enabled/sql` and you have configured the appropriate sql dialect,
you should start the server as usual:

------------
$ radiusd -X
------------

If all has gone well, the server should print out the normal "Ready to
process requests" message. Scroll up in your terminal window, and there
should be messages from the `sql` module, such as:

--------------
rlm_sql_sqlite: Database doesn't exist, creating it and loading schema
rlm_sql_sqlite: Executing SQL statements from file "/etc/raddb/mods-config/sql/main/sqlite/schema.sql"
rlm_sql (sql): Driver rlm_sql_sqlite (module rlm_sql_sqlite) loaded and linked
rlm_sql (sql): Attempting to connect to database "radius"
rlm_sql (sql): Initialising connection pool
   pool {
   	start = 5
   	min = 4
   	max = 100
   	spare = 3
   	uses = 0
   	lifetime = 0
   	cleanup_interval = 30
   	idle_timeout = 60
   	retry_delay = 1
   	spread = no
   }
rlm_sql (sql): Opening additional connection (0)
rlm_sql_sqlite: Opening SQLite database "/tmp/freeradius.db"
rlm_sql (sql): Opening additional connection (1)
rlm_sql_sqlite: Opening SQLite database "/tmp/freeradius.db"
rlm_sql (sql): Opening additional connection (2)
rlm_sql_sqlite: Opening SQLite database "/tmp/freeradius.db"
rlm_sql (sql): Opening additional connection (3)
rlm_sql_sqlite: Opening SQLite database "/tmp/freeradius.db"
rlm_sql (sql): Opening additional connection (4)
rlm_sql_sqlite: Opening SQLite database "/tmp/freeradius.db"
--------------

These messages indicate that the server was able to load the `sql`
module, and that the `sql` module was able to communicate with the SQL
server.

If there is a problem with shared libraries, or with access permissions
to the SQL database, then an error message will be printed, and the
server will not start properly. The FreeRADIUS FAQ and the
`radiusd.conf` file, entry "libdir", contain information as to how to
fix shared library issues.

If there are issues connecting to the database you should verify manually
that you can connect to the SQL database using the given "server",
"login", and "password". The SQL database should come with a test
client which may be used to perform this test.

Now stop the server. The next exercise will be to add the schema to the
database, and to populate it with a test entry.

== Questions

1.  Why is it important to test SQL connectivity, independently of
testing the ability to obtain user configuration from an SQL database?
2.  Why are there different configuration files for each SQL server?
3.  What additional benefits, not mentioned here, do SQL databases have
over the files module?

// Copyright (C) 2021 Network RADIUS SAS.  Licenced under CC-by-NC 4.0.
// This documentation was developed by Network RADIUS SAS.
