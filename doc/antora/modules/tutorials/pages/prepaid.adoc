= A simple pre-paid example

*Goal:* To implement a simple "prepaid" functionality in the server.

*Time:* 15-25 minutes

*Files:*

- `mods-enabled/sqlcounter`
- `sites-enabled/default`
- `mods-config/files/authorize`

== Overview

Many system administrators wish to implement `prepaid` billing for their systems. In this exercise, we will configure the server to use a simple `prepaid` scheme, wherein all users will be permitted to log in for only one hour a day using the `sqlcounter` module.

=== SQLCounter Module Configuration

Create a symbolic link from mods-available/ to mods-enable/:

[source,bash]
----
$ cd mods-enabled
$ ln -s ../mods-available/sqlcounter sqlcounter
----

Verify the symbolic link was created:

[source,bash]
----
$ cat mods-enabled/sqlcounter
----

The `mods-enabled/sqlcounter` should contain a `daily counter` instance similar to the following:

[source,unlang]
----
sqlcounter dailycounter {
	sql_module_instance = sql
	dialect = ${modules.sql.dialect}

#	reset_period_start_name = control.${.:instance}-Reset-Start
#	reset_period_end_name = control.${.:instance}-Reset-End
	counter_name = control.Daily-Session-Time
	check_name = control.Max-Daily-Session
	reply_name = reply.Session-Timeout
	auto_extend = yes
	key="%{Stripped-User-Name || User-Name}"
	reply_message_name = Reply-Message

	reset = daily

	$INCLUDE ${modconfdir}/sql/counter/${dialect}/${.:instance}.conf
}
----

The `sql_module_instance` defines which SQL connection to use, and `dialect = ${modules.sql.dialect}` ensures the correct database type is applied. The `counter_name` is used for identification and logging, while `check_name` specifies the control attribute that holds the usage limit (e.g., Max-Daily-Session). The `reply_name` defines the reply attribute (usually Session-Timeout) sent to the NAS. The `auto_extend` option allows timeout extension until the next reset period. The `key` identifies the lookup attribute (typically User-Name), `reply_message_name` defines the reply message attribute, and `reset` determines when the counter is cleared (daily, weekly, monthly, or never).

== Questions

1.  How would you configure the server to obtain the daily access limits
from an SQL database?
2.  Why is it useful to enforce time-based restrictions on users, in
addition to enforcing `Simultaneous-Use`?

// Copyright (C) 2021 Network RADIUS SAS.  Licenced under CC-by-NC 4.0.
// This documentation was developed by Network RADIUS SAS.
